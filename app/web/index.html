<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OTORI</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0a0d12;
      --panel: #12171f;
      --panel2: #0f1319;
      --panel-hover: #1a2029;
      --border: #1e2733;
      --border-light: #2a3444;
      --text: #e8eaed;
      --muted: #8b95a5;
      --accent: #ff4fd8;
      --accent-soft: rgba(255, 79, 216, 0.15);
      --blue: #4cc9ff;
      --blue-soft: rgba(76, 201, 255, 0.15);
      --green: #34d399;
      --green-soft: rgba(52, 211, 153, 0.15);
      --red: #f87171;
      --red-soft: rgba(248, 113, 113, 0.15);
      --yellow: #fbbf24;
      --yellow-soft: rgba(251, 191, 36, 0.15);
      --orange: #fb923c;
      --orange-soft: rgba(251, 146, 60, 0.15);
      --purple: #a78bfa;
      --purple-soft: rgba(167, 139, 250, 0.15);
      --radius: 12px;
      --radius-sm: 8px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    .app {
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      gap: 40px;
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      display: flex;
      align-items: center;
    }

    .ascii-logo {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      line-height: 1.15;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      white-space: pre;
    }

    .header-nav {
      display: flex;
      gap: 6px;
    }

    .header-spacer {
      flex: 1;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .nav-btn {
      padding: 10px 20px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 8px;
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .nav-btn:hover {
      color: var(--text);
      background: var(--panel);
    }

    .nav-btn.active {
      background: var(--accent-soft);
      border-color: rgba(255, 79, 216, 0.3);
      color: var(--accent);
    }

    .settings-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .settings-btn:hover {
      background: var(--panel-hover);
      border-color: var(--border-light);
      color: var(--text);
    }

    .settings-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Pages */
    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* KPI Cards Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 40px;
    }

    .kpi-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      transition: all 0.2s ease;
    }

    .kpi-card:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
    }

    .kpi-card .label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
      margin-bottom: 12px;
      font-weight: 600;
    }

    .kpi-card .value {
      font-size: 36px;
      font-weight: 800;
      color: var(--text);
      line-height: 1;
    }

    .kpi-card .value.accent { color: var(--accent); }
    .kpi-card .value.blue { color: var(--blue); }
    .kpi-card .value.green { color: var(--green); }
    .kpi-card .value.red { color: var(--red); }
    .kpi-card .value.yellow { color: var(--yellow); }
    .kpi-card .value.orange { color: var(--orange); }
    .kpi-card .value.purple { color: var(--purple); }

    .kpi-card .sub {
      font-size: 13px;
      color: var(--muted);
      margin-top: 8px;
    }

    /* Section Title */
    .section-title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 16px;
      background: var(--accent);
      border-radius: 2px;
    }

    /* Cards */
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title .badge {
      font-size: 11px;
      padding: 5px 10px;
      background: var(--accent-soft);
      color: var(--accent);
      border-radius: 8px;
      font-weight: 600;
    }

    /* Chart Container */
    .chart-container {
      position: relative;
      height: 280px;
    }

    .chart-container.medium {
      height: 220px;
    }

    .chart-container.small {
      height: 180px;
    }

    /* Grid Layouts */
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      margin-bottom: 40px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      margin-bottom: 40px;
    }

    .grid-4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 24px;
      margin-bottom: 40px;
    }

    /* Stats inside cards */
    .stats-row {
      display: flex;
      gap: 16px;
      margin-top: 16px;
    }

    .stat-item {
      flex: 1;
      padding: 14px;
      background: var(--panel2);
      border-radius: var(--radius-sm);
      text-align: center;
    }

    .stat-item .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
    }

    .stat-item .stat-label {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      text-transform: uppercase;
    }

    /* Top Lists */
    .top-list {
      max-height: 350px;
      overflow-y: auto;
    }

    .top-item {
      display: flex;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
      gap: 12px;
    }

    .top-item:last-child {
      border-bottom: none;
    }

    .top-item .rank {
      width: 28px;
      height: 28px;
      background: var(--panel2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      flex-shrink: 0;
    }

    .top-item .rank.top3 {
      background: var(--accent-soft);
      color: var(--accent);
    }

    .top-item .content {
      flex: 1;
      min-width: 0;
    }

    .top-item .name {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .top-item .meta {
      font-size: 11px;
      color: var(--muted);
      margin-top: 3px;
    }

    .top-item .count {
      font-weight: 700;
      font-size: 14px;
      color: var(--blue);
      flex-shrink: 0;
    }

    /* Badges */
    .severity-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .severity-badge.critical { background: var(--red-soft); color: var(--red); }
    .severity-badge.high { background: var(--orange-soft); color: var(--orange); }
    .severity-badge.medium { background: var(--yellow-soft); color: var(--yellow); }
    .severity-badge.low { background: var(--green-soft); color: var(--green); }
    .severity-badge.info { background: var(--panel2); color: var(--muted); }

    .danger-badge {
      display: inline-flex;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .danger-badge.critical { background: var(--red-soft); color: var(--red); }
    .danger-badge.high { background: var(--orange-soft); color: var(--orange); }
    .danger-badge.medium { background: var(--yellow-soft); color: var(--yellow); }
    .danger-badge.low, .danger-badge.minimal { background: var(--green-soft); color: var(--green); }
    .danger-badge.unknown { background: var(--panel2); color: var(--muted); }

    .attacker-badge {
      display: inline-flex;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .attacker-badge.bot { background: var(--purple-soft); color: var(--purple); }
    .attacker-badge.human { background: var(--blue-soft); color: var(--blue); }
    .attacker-badge.hybrid, .attacker-badge.unknown { background: var(--panel2); color: var(--muted); }

    /* Sessions Table */
    .table-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
    }

    .table-scroll {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }

    thead th {
      text-align: left;
      padding: 14px 16px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
      font-weight: 700;
      background: var(--panel2);
    }

    tbody td {
      padding: 16px;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    tbody tr:hover {
      background: var(--panel-hover);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .ip-cell {
      font-family: 'JetBrains Mono', monospace;
      color: var(--blue);
    }

    .flag {
      font-size: 16px;
      margin-right: 6px;
    }

    .code {
      font-size: 12px;
      color: var(--muted);
    }

    .score-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: help;
    }

    .score-bar {
      display: inline-block;
      width: 50px;
      height: 6px;
      background: var(--panel2);
      border-radius: 3px;
      overflow: hidden;
      vertical-align: middle;
    }

    .score-bar-fill {
      display: block;
      height: 100%;
      border-radius: 3px;
    }

    .score-bar-fill.critical { background: var(--red); }
    .score-bar-fill.high { background: var(--orange); }
    .score-bar-fill.medium { background: var(--yellow); }
    .score-bar-fill.low { background: var(--green); }

    .score-value {
      font-weight: 600;
      font-size: 12px;
    }

    /* Language Button */
    .lang-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--muted);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .lang-btn:hover {
      background: var(--panel-hover);
      border-color: var(--border-light);
      color: var(--text);
    }

    /* Tooltip */
    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 11px;
      color: var(--text);
      white-space: nowrap;
      z-index: 100;
      margin-bottom: 6px;
    }

    /* MITRE Items */
    .mitre-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--panel2);
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--accent);
      margin-bottom: 10px;
    }

    .mitre-item:last-child { margin-bottom: 0; }

    .mitre-item .id {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
    }

    .mitre-item .name {
      flex: 1;
      font-size: 12px;
      color: var(--text);
    }

    .mitre-item .count {
      font-size: 13px;
      font-weight: 700;
      color: var(--muted);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
      .grid-3 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .kpi-grid { grid-template-columns: 1fr; }
      .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
      .header { flex-direction: column; gap: 16px; }
      .nav-bar { flex-wrap: wrap; justify-content: center; }
      .ascii-logo { font-size: 7px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <pre class="ascii-logo"> ██████╗ ████████╗ ██████╗ ██████╗ ██╗
██╔═══██╗╚══██╔══╝██╔═══██╗██╔══██╗██║
██║   ██║   ██║   ██║   ██║██████╔╝██║
██║   ██║   ██║   ██║   ██║██╔══██╗██║
╚██████╔╝   ██║   ╚██████╔╝██║  ██║██║
 ╚═════╝    ╚═╝    ╚═════╝ ╚═╝  ╚═╝╚═╝</pre>
      </div>
      <nav class="header-nav">
        <button class="nav-btn active" data-page="overview" data-i18n="nav.overview">Vue d'ensemble</button>
        <button class="nav-btn" data-page="analytics" data-i18n="nav.analytics">Analyse</button>
        <button class="nav-btn" data-page="sessions" data-i18n="nav.sessions">Sessions</button>
      </nav>
      <div class="header-spacer"></div>
      <div class="header-actions">
        <button class="lang-btn" id="lang-toggle" onclick="toggleLanguage()">FR</button>
        <button class="settings-btn" onclick="alert('Settings coming soon!')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
      </button>
      </div>
    </header>

    <!-- Page: Overview -->
    <div id="page-overview" class="page active">
      <!-- KPI Cards -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="label" data-i18n="kpi.totalSessions">Total Sessions</div>
          <div class="value accent" id="kpi-sessions">0</div>
          <div class="sub" data-i18n="kpi.last24h">dernières 24h</div>
        </div>
        <div class="kpi-card">
          <div class="label" data-i18n="kpi.uniqueIps">IPs Uniques</div>
          <div class="value blue" id="kpi-ips">0</div>
          <div class="sub" data-i18n="kpi.distinctAttackers">attaquants distincts</div>
        </div>
        <div class="kpi-card">
          <div class="label" data-i18n="kpi.commands">Commandes</div>
          <div class="value" id="kpi-commands">0</div>
          <div class="sub"><span id="kpi-cmds-session">0</span> <span data-i18n="kpi.perSession">par session</span></div>
        </div>
        <div class="kpi-card">
          <div class="label" data-i18n="kpi.avgDuration">Durée Moyenne</div>
          <div class="value green" id="kpi-duration">0s</div>
          <div class="sub" data-i18n="kpi.perSession">par session</div>
        </div>
      </div>

      <!-- Activity Chart -->
      <div class="section-title" data-i18n="section.activityTimeline">Chronologie d'activité</div>
      <div class="card" style="margin-bottom: 40px;">
        <div class="card-title">
          Sessions & Commandes
          <span class="badge" id="timeline-total">0 sessions</span>
        </div>
        <div class="chart-container">
          <canvas id="activityChart"></canvas>
        </div>
      </div>

      <!-- Two columns -->
      <div class="grid-2">
        <div class="card">
          <div class="card-title" data-i18n="card.authentication">Authentification</div>
          <div class="chart-container medium">
            <canvas id="loginChart"></canvas>
          </div>
          <div class="stats-row">
            <div class="stat-item">
              <div class="stat-value" style="color: var(--green)" id="login-success">0</div>
              <div class="stat-label" data-i18n="auth.success">Succès</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" style="color: var(--red)" id="login-failed">0</div>
              <div class="stat-label" data-i18n="auth.failed">Échecs</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="unique-usernames">0</div>
              <div class="stat-label" data-i18n="auth.usernames">Identifiants</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="unique-passwords">0</div>
              <div class="stat-label" data-i18n="auth.passwords">Mots de passe</div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title" data-i18n="card.topIps">Top IPs</div>
          <div class="top-list" id="top-ips"></div>
        </div>
      </div>
    </div>

    <!-- Page: Sessions -->
    <div id="page-sessions" class="page">
      <div class="table-card">
        <div class="table-header">
          <div class="table-title" data-i18n="table.allSessions">Toutes les Sessions</div>
          <span id="session-count" style="color: var(--muted); font-size: 13px;">0 sessions</span>
        </div>
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th data-i18n="table.sourceIp">IP Source</th>
                <th data-i18n="table.country">Pays</th>
                <th data-i18n="table.username">Identifiant</th>
                <th data-i18n="table.cmds">Cmds</th>
                <th data-i18n="table.dangerScore" data-i18n-tooltip="tooltip.dangerScore">Score de danger</th>
                <th data-i18n="table.level">Niveau</th>
                <th data-i18n="table.attacker">Attaquant</th>
                <th data-i18n="table.duration">Durée</th>
              </tr>
            </thead>
            <tbody id="sessions-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Page: Analytics -->
    <div id="page-analytics" class="page">
      <!-- Analytics KPIs -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="label" data-i18n="kpi.criticalCmds">Commandes Critiques</div>
          <div class="value red" id="kpi-critical">0</div>
          <div class="sub" data-i18n="kpi.criticalLevel">niveau critique</div>
        </div>
        <div class="kpi-card">
          <div class="label" data-i18n="kpi.highSessions">Sessions High+</div>
          <div class="value orange" id="kpi-high-sessions">0</div>
          <div class="sub" data-i18n="kpi.highDanger">danger élevé</div>
        </div>
        <div class="kpi-card">
          <div class="label" data-i18n="kpi.mitreTechniques">Techniques MITRE</div>
          <div class="value purple" id="kpi-mitre">0</div>
          <div class="sub" data-i18n="kpi.detected">détectées</div>
        </div>
        <div class="kpi-card">
          <div class="label" data-i18n="kpi.botRatio">Ratio Bots</div>
          <div class="value blue" id="kpi-bot-ratio">0%</div>
          <div class="sub" data-i18n="kpi.vsHumans">vs humains</div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="section-title" data-i18n="section.threatDistribution">Distribution des menaces</div>
      <div class="grid-2">
        <div class="card">
          <div class="card-title" data-i18n="card.attackCategories">Catégories d'Attaque</div>
          <div class="chart-container medium">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-title" data-i18n="card.cmdSeverity">Sévérité des Commandes</div>
          <div class="chart-container medium">
            <canvas id="severityChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Bottom Row -->
      <div class="section-title" data-i18n="section.detailedAnalysis">Analyse détaillée</div>
      <div class="grid-3">
        <div class="card">
          <div class="card-title" data-i18n="card.dangerousCmds">Commandes les plus dangereuses</div>
          <div class="top-list" id="top-dangerous"></div>
        </div>
        <div class="card">
          <div class="card-title" data-i18n="card.mitreTechniques">Techniques MITRE ATT&CK</div>
          <div class="top-list" id="top-mitre"></div>
        </div>
        <div class="card">
          <div class="card-title" data-i18n="card.topPasswords">Mots de passe fréquents</div>
          <div class="top-list" id="top-passwords"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Chart.js config
    Chart.defaults.color = '#8b95a5';
    Chart.defaults.borderColor = '#1e2733';
    Chart.defaults.font.family = 'Inter, sans-serif';

    // ═══════════════════════════════════════════════════════════════
    // i18n System
    // ═══════════════════════════════════════════════════════════════
    const I18N = {
      fr: {
        nav: { overview: "Vue d'ensemble", sessions: "Sessions", analytics: "Analyse" },
        kpi: {
          totalSessions: "Total Sessions", uniqueIps: "IPs Uniques", commands: "Commandes",
          avgDuration: "Durée Moyenne", last24h: "dernières 24h", distinctAttackers: "attaquants distincts",
          perSession: "par session", criticalCmds: "Commandes Critiques", criticalLevel: "niveau critique",
          highSessions: "Sessions High+", highDanger: "danger élevé", mitreTechniques: "Techniques MITRE",
          detected: "détectées", botRatio: "Ratio Bots", vsHumans: "vs humains"
        },
        section: {
          activityTimeline: "Chronologie d'activité", threatDistribution: "Distribution des menaces",
          detailedAnalysis: "Analyse détaillée"
        },
        card: {
          authentication: "Authentification", topIps: "Top IPs", attackCategories: "Catégories d'Attaque",
          cmdSeverity: "Sévérité des Commandes", dangerousCmds: "Commandes les plus dangereuses",
          mitreTechniques: "Techniques MITRE ATT&CK", topPasswords: "Mots de passe fréquents"
        },
        auth: { success: "Succès", failed: "Échecs", usernames: "Identifiants", passwords: "Mots de passe" },
        table: {
          allSessions: "Toutes les Sessions", sourceIp: "IP Source", country: "Pays",
          username: "Identifiant", cmds: "Cmds", dangerScore: "Score", level: "Niveau",
          attacker: "Attaquant", duration: "Durée"
        },
        tooltip: { dangerScore: "Score 0-100 basé sur: sévérité, catégories, logins, durée" },
        chart: { sessions: "Sessions", commands: "Commandes", success: "Succès", failed: "Échecs" },
        empty: { noData: "Aucune donnée", noSession: "Aucune session" }
      },
      en: {
        nav: { overview: "Overview", sessions: "Sessions", analytics: "Analytics" },
        kpi: {
          totalSessions: "Total Sessions", uniqueIps: "Unique IPs", commands: "Commands",
          avgDuration: "Avg Duration", last24h: "last 24h", distinctAttackers: "distinct attackers",
          perSession: "per session", criticalCmds: "Critical Commands", criticalLevel: "critical level",
          highSessions: "High+ Sessions", highDanger: "high danger", mitreTechniques: "MITRE Techniques",
          detected: "detected", botRatio: "Bot Ratio", vsHumans: "vs humans"
        },
        section: {
          activityTimeline: "Activity Timeline", threatDistribution: "Threat Distribution",
          detailedAnalysis: "Detailed Analysis"
        },
        card: {
          authentication: "Authentication", topIps: "Top IPs", attackCategories: "Attack Categories",
          cmdSeverity: "Command Severity", dangerousCmds: "Most Dangerous Commands",
          mitreTechniques: "MITRE ATT&CK Techniques", topPasswords: "Common Passwords"
        },
        auth: { success: "Success", failed: "Failed", usernames: "Usernames", passwords: "Passwords" },
        table: {
          allSessions: "All Sessions", sourceIp: "Source IP", country: "Country",
          username: "Username", cmds: "Cmds", dangerScore: "Score", level: "Level",
          attacker: "Attacker", duration: "Duration"
        },
        tooltip: { dangerScore: "Score 0-100 based on: severity, categories, logins, duration" },
        chart: { sessions: "Sessions", commands: "Commands", success: "Success", failed: "Failed" },
        empty: { noData: "No data", noSession: "No session" }
      }
    };

    let currentLang = localStorage.getItem('otori-lang') || 'fr';

    function t(key) {
      const keys = key.split('.');
      let val = I18N[currentLang];
      for (const k of keys) {
        val = val?.[k];
      }
      return val || key;
    }

    function applyTranslations() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        el.textContent = t(el.dataset.i18n);
      });
      document.querySelectorAll('[data-i18n-tooltip]').forEach(el => {
        el.setAttribute('data-tooltip', t(el.dataset.i18nTooltip));
      });
      document.getElementById('lang-toggle').textContent = currentLang.toUpperCase();
      // Update chart labels
      if (activityChart) {
        activityChart.data.datasets[0].label = t('chart.sessions');
        activityChart.data.datasets[1].label = t('chart.commands');
        activityChart.update('none');
      }
      if (loginChart) {
        loginChart.data.labels = [t('chart.success'), t('chart.failed')];
        loginChart.update('none');
      }
    }

    function toggleLanguage() {
      currentLang = currentLang === 'fr' ? 'en' : 'fr';
      localStorage.setItem('otori-lang', currentLang);
      applyTranslations();
    }

    let activityChart, loginChart, categoryChart, severityChart;

    const COLORS = {
      accent: '#ff4fd8',
      blue: '#4cc9ff',
      green: '#34d399',
      red: '#f87171',
      yellow: '#fbbf24',
      orange: '#fb923c',
      purple: '#a78bfa',
      muted: '#8b95a5'
    };

    const CATEGORY_COLORS = {
      recon: COLORS.blue,
      download: COLORS.orange,
      persist: COLORS.red,
      credential: COLORS.purple,
      execution: COLORS.yellow,
      exfil: COLORS.accent,
      evasion: COLORS.muted,
      lateral: COLORS.green,
      impact: '#ef4444',
      benign: '#6b7280',
      unknown: '#4b5563'
    };

    const SEVERITY_COLORS = {
      critical: COLORS.red,
      high: COLORS.orange,
      medium: COLORS.yellow,
      low: COLORS.green,
      info: COLORS.muted
    };

    // Navigation
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('page-' + btn.dataset.page).classList.add('active');
      });
    });

    // Charts initialization
    function initActivityChart() {
      const ctx = document.getElementById('activityChart').getContext('2d');
      activityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Sessions',
              data: [],
              borderColor: COLORS.accent,
              backgroundColor: 'rgba(255, 79, 216, 0.1)',
              fill: true,
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 6,
              borderWidth: 2,
            },
            {
              label: 'Commandes',
              data: [],
              borderColor: COLORS.blue,
              backgroundColor: 'rgba(76, 201, 255, 0.1)',
              fill: true,
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 6,
              borderWidth: 2,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: { display: true, position: 'top', align: 'end', labels: { boxWidth: 12, padding: 20 } }
          },
          scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true, grid: { color: '#1e2733' } }
          }
        }
      });
    }

    function initLoginChart() {
      const ctx = document.getElementById('loginChart').getContext('2d');
      loginChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Succès', 'Échecs'],
          datasets: [{
            data: [0, 0],
            backgroundColor: [COLORS.green, COLORS.red],
            borderWidth: 0,
            spacing: 3,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: { legend: { display: false } }
        }
      });
    }

    function initCategoryChart() {
      const ctx = document.getElementById('categoryChart').getContext('2d');
      categoryChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: [],
            borderRadius: 6,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { color: '#1e2733' }, beginAtZero: true },
            y: { grid: { display: false } }
          }
        }
      });
    }

    function initSeverityChart() {
      const ctx = document.getElementById('severityChart').getContext('2d');
      severityChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: [],
            borderWidth: 0,
            spacing: 3,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '55%',
          plugins: {
            legend: { display: true, position: 'right', labels: { boxWidth: 12, padding: 12, font: { size: 11 } } }
          }
        }
      });
    }

    // Helpers
    function fmtDuration(sec) {
      if (sec === null || sec === undefined || isNaN(sec)) return '-';
      sec = Math.round(Number(sec));
      if (sec < 60) return `${sec}s`;
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      if (m < 60) return `${m}m ${s}s`;
      const h = Math.floor(m / 60);
      return `${h}h ${m % 60}m`;
    }

    function esc(s) {
      return (s || '').toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function countryCodeToFlag(code) {
      if (!code || code === 'PRIVATE' || code.length !== 2) return '';
      const offset = 127397;
      return String.fromCodePoint(...[...code.toUpperCase()].map(c => c.charCodeAt(0) + offset));
    }

    // Render functions
    function renderTopList(containerId, items, key) {
      const container = document.getElementById(containerId);
      if (!items || items.length === 0) {
        container.innerHTML = `<div class="empty-state">${t('empty.noData')}</div>`;
        return;
      }
      container.innerHTML = items.slice(0, 10).map((item, i) => `
        <div class="top-item">
          <span class="rank ${i < 3 ? 'top3' : ''}">${i + 1}</span>
          <div class="content">
            <div class="name">${esc(item[key])}</div>
          </div>
          <span class="count">${item.count}</span>
        </div>
      `).join('');
    }

    function renderDangerousCmds(items) {
      const container = document.getElementById('top-dangerous');
      if (!items || items.length === 0) {
        container.innerHTML = `<div class="empty-state">${t('empty.noData')}</div>`;
        return;
      }
      container.innerHTML = items.slice(0, 8).map((item, i) => `
        <div class="top-item">
          <span class="severity-badge ${item.severity}">${item.severity}</span>
          <div class="content">
            <div class="name">${esc(item.command?.substring(0, 40) || '')}</div>
            <div class="meta">${item.category || ''}</div>
          </div>
          <span class="count">${item.count}</span>
        </div>
      `).join('');
    }

    function renderMitreTechniques(techniques) {
      const container = document.getElementById('top-mitre');
      if (!techniques || techniques.length === 0) {
        container.innerHTML = `<div class="empty-state">${t('empty.noData')}</div>`;
        return;
      }
      container.innerHTML = techniques.slice(0, 8).map(t => `
        <div class="mitre-item">
          <span class="id">${t.technique || t.technique_id || ''}</span>
          <span class="name">${t.name || ''}</span>
          <span class="count">${t.count}</span>
        </div>
      `).join('');
    }

    // Main update
    function updateDashboard(kpi, recent) {
      // Overview KPIs
      document.getElementById('kpi-sessions').textContent = kpi.total_sessions || 0;
      document.getElementById('kpi-ips').textContent = kpi.unique_ips || 0;
      document.getElementById('kpi-commands').textContent = kpi.total_commands || 0;
      document.getElementById('kpi-cmds-session').textContent = kpi.cmds_per_session || 0;
      document.getElementById('kpi-duration').textContent = fmtDuration(kpi.avg_duration_sec);
      document.getElementById('timeline-total').textContent = `${kpi.total_sessions || 0} sessions`;

      // Auth stats
      document.getElementById('login-success').textContent = kpi.login_success || 0;
      document.getElementById('login-failed').textContent = kpi.login_failed || 0;
      document.getElementById('unique-usernames').textContent = kpi.unique_usernames || 0;
      document.getElementById('unique-passwords').textContent = kpi.unique_passwords || 0;

      // Analytics KPIs
      document.getElementById('kpi-critical').textContent = kpi.critical_commands || 0;
      document.getElementById('kpi-high-sessions').textContent = (kpi.sessions_critical || 0) + (kpi.sessions_high || 0);
      document.getElementById('kpi-mitre').textContent = kpi.top_mitre_techniques?.length || 0;
      document.getElementById('kpi-bot-ratio').textContent = Math.round(kpi.bot_ratio || 0) + '%';

      // Activity chart
      if (activityChart && kpi.sessions_timeline) {
        activityChart.data.labels = kpi.sessions_timeline.map(t => t.label);
        activityChart.data.datasets[0].data = kpi.sessions_timeline.map(t => t.count);
        activityChart.data.datasets[1].data = kpi.commands_timeline?.map(t => t.count) || [];
        activityChart.update('none');
      }

      // Login chart
      if (loginChart) {
        loginChart.data.datasets[0].data = [kpi.login_success || 0, kpi.login_failed || 0];
        loginChart.update('none');
      }

      // Category chart
      if (categoryChart && kpi.category_distribution) {
        const cats = kpi.category_distribution.slice(0, 8);
        categoryChart.data.labels = cats.map(c => c.category);
        categoryChart.data.datasets[0].data = cats.map(c => c.count);
        categoryChart.data.datasets[0].backgroundColor = cats.map(c => CATEGORY_COLORS[c.category] || COLORS.muted);
        categoryChart.update('none');
      }

      // Severity chart
      if (severityChart && kpi.severity_distribution) {
        const order = ['critical', 'high', 'medium', 'low', 'info'];
        const sevs = order.map(s => kpi.severity_distribution.find(x => x.severity === s)).filter(Boolean);
        severityChart.data.labels = sevs.map(s => s.severity);
        severityChart.data.datasets[0].data = sevs.map(s => s.count);
        severityChart.data.datasets[0].backgroundColor = sevs.map(s => SEVERITY_COLORS[s.severity] || COLORS.muted);
        severityChart.update('none');
      }

      // Top lists
      renderTopList('top-ips', kpi.top_ips, 'ip');
      renderTopList('top-passwords', kpi.top_passwords, 'password');
      renderDangerousCmds(kpi.top_dangerous_commands);
      renderMitreTechniques(kpi.top_mitre_techniques);

      // Sessions table
      document.getElementById('session-count').textContent = `${recent?.length || 0} sessions`;
      const tbody = document.getElementById('sessions-tbody');
      if (!recent || recent.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="empty-state">${t('empty.noSession')}</td></tr>`;
        return;
      }
      tbody.innerHTML = recent.map(s => {
        const dangerClass = s.danger_level || 'unknown';
        const attackerClass = s.attacker_type || 'unknown';
        const scoreClass = s.danger_score >= 80 ? 'critical' : s.danger_score >= 50 ? 'high' : s.danger_score >= 25 ? 'medium' : 'low';
        const flag = countryCodeToFlag(s.country_code);

        return `
          <tr>
            <td class="ip-cell">${esc(s.src_ip) || '-'}</td>
            <td><span class="flag">${flag}</span><span class="code">${esc(s.country_code) || '-'}</span></td>
            <td>${esc(s.username) || '-'}</td>
            <td>${s.command_count || 0}</td>
            <td><span class="score-wrapper" data-tooltip="${t('tooltip.dangerScore')}"><span class="score-bar"><span class="score-bar-fill ${scoreClass}" style="width: ${s.danger_score || 0}%"></span></span><span class="score-value">${s.danger_score || 0}</span></span></td>
            <td><span class="danger-badge ${dangerClass}">${dangerClass}</span></td>
            <td><span class="attacker-badge ${attackerClass}">${attackerClass}</span></td>
            <td>${fmtDuration(s.duration_sec)}</td>
          </tr>
        `;
      }).join('');
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      initActivityChart();
      initLoginChart();
      initCategoryChart();
      initSeverityChart();
      applyTranslations();

      Promise.all([
        fetch('/kpi').then(r => r.json()),
        fetch('/sessions/recent?limit=25').then(r => r.json())
      ]).then(([kpi, recent]) => {
        updateDashboard(kpi, recent);
      }).catch(err => console.error('Load error:', err));

      // WebSocket
      const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws = new WebSocket(`${wsProtocol}//${location.host}/ws`);
      ws.onopen = () => ws.send('subscribe');
      ws.onmessage = (msg) => {
        try {
          const data = JSON.parse(msg.data);
          if (data.type === 'update') updateDashboard(data.kpi, data.recent);
        } catch (e) {}
      };
      ws.onclose = () => setTimeout(() => location.reload(), 5000);
    });
  </script>
</body>
</html>
